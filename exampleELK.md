# ELK Example Config

Here we show how to configure the ELK stack (ElasticSearch, LogStash, Kibana) to use SearchGuard.  We use demo certificates generated by SearchGuard.

1. [Install SearchGuard Plugin in ElasticSearch](exampleELK.md#install)
2. [Generate TLS Demo certificates](exampleELK.md#cert) 
3. [Kibana Install SearchGuard Plugin](exampleELK.md#kibana)	 
4. [Install and Configure Logstash](exampleELK.md#logstash)	 
 


## <a name="install"></a>  Install SearchGuard Plugin in ElasticSearch
Consult the [version support matrix](https://github.com/floragunncom/search-guard/wiki) to match the SG plugin verion to the ES version.

Then install it:


`./elasticsearch-plugin install -b com.floragunn:search-guard-5:5.2.2-12`

If you get any errors about not having enough memory you can increase the user quota by:

`sysctl -w vm.max_map_count=262144`


## <a name="cert"></a> Demo Cert Installation

Run:

`sudo chmod +x <ES dir>/plugins/search-guard-5/tools/`

`<ES dir>/plugins/search-guard-5/tools/install_demo_configuration.sh`

Then restart ElasticSearch and then run:

`<ES dir>/plugins/search-guard-5/tools/sgadmin_demo.sh`

elasticsearch.yml will be update to:

 
```
######## Start Search Guard Demo Configuration ########
searchguard.ssl.transport.keystore_filepath: keystore.jks
searchguard.ssl.transport.truststore_filepath: truststore.jks
searchguard.ssl.transport.enforce_hostname_verification: false
searchguard.ssl.http.enabled: true
searchguard.ssl.http.keystore_filepath: keystore.jks
searchguard.ssl.http.truststore_filepath: truststore.jks
searchguard.authcz.admin_dn:
  - CN=kirk,OU=client,O=client,L=test, C=de

cluster.name: searchguard_demo
network.host: 0.0.0.0
######## End Search Guard Demo Configuration ########
```

Now log into https://localhost:9200/ with admin/admin, click through the certificate warning.  It should show:

```
{
  "name" : "2EPefDX",
  "cluster_name" : "searchguard_demo",
  "cluster_uuid" : "sZ6iqxppQrCKpqvaHqbgZQ",
  "version" : {
    "number" : "5.2.2",
    "build_hash" : "f9d9b74",
    "build_date" : "2017-02-24T17:26:45.835Z",
    "build_snapshot" : false,
    "lucene_version" : "6.4.1"
  },
  "tagline" : "You Know, for Search"
}
```

## <a name="kibana"></a> Kibana Install SearchGuard Plugin


```
bin/kibana-plugin install file:///searchguard-kibana-5.3.2-2.zip
```
It is not necessary to add any config options to kibana.yml except the ElasticSearch username and password, turn off cert validation, and change http to https.  The default values for other parameters will work, so it is not necessary to put those.

```
sudo cat /usr/share/kibana/kibana-5.2.2-linux-x86_64/config/kibana.yml 

elasticsearch.username: "kibanaserver"
elasticsearch.password: "kibanaserver"
elasticsearch.url: "https://localhost:9200"
elasticsearch.ssl.verification: none
```

**Note:** elasticsearch.ssl.verification is spelled elasticsearch.ssl.verificationMode in earlier versions in Kibana. 


Now login to http://localhost:5601.  You can use any of the passwords in <ES_DIR>pluginonfig/sg_internal_users.yml.

cat /usr/share/filebeat/filebeat-5.4.0-linux-x86_64/filebeat.yml

## <a name="logstash|"></a> Configure LogStash


```
cat /etc/logstash/conf.d/wordpress.conf

input {
    file {
        path => "/tmp/log/so*"
        type => "apache"
        start_position => "beginning"
    }
}

output {
  elasticsearch {
    hosts => ["eurovps:9200"]
ssl => true
ssl_certificate_verification => false
       truststore => "/usr/share/elasticsearch/elasticsearch-5.2.2/config/truststore.jks"
       truststore_password => changeit
  }
}


```

Then start logstash

`sudo ./logstash -f /etc/logstash/conf.d/wordpress.conf`
