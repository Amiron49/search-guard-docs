# ELK Example Config

Here we show how to configure the ELK stack (ElasticSearch, LogStash, Kibana) to use SearchGuard.  We use demo certificates generated by SearchGuard.

1. [Install SearchGuard Plugin in ElasticSearch](exampleELK.md#install)
2. [Generate TLS Demo certificates](exampleELK.md#cert) 
3. [Configure Kibana](exampleELK.md#kibana)	 
4. [Configure Logstash](exampleELK.md#logstash)	 

 


## <a name="install"></a>  Install SearchGuard Plugin in ElasticSearch
Consult the [version support matrix](https://github.com/floragunncom/search-guard/wiki) to match the SG plugin verion to the ES version.

Then install it:


`./elasticsearch-plugin install -b com.floragunn:search-guard-5:5.2.2-12`

If you get any errors about not having enough memory you can increase the user quota by:

`sysctl -w vm.max_map_count=262144`


## <a name="cert"></a> Demo Cert Installation

Run:

`sudo chmod +x <ES dir>/plugins/search-guard-5/tools/`

`<ES dir>/plugins/search-guard-5/tools/install_demo_configuration.sh`

Then restart ElasticSearch and then run:

`<ES dir>/plugins/search-guard-5/tools/sgadmin_demo.sh`

elasticsearch.yml will be update to:

 
```
######## Start Search Guard Demo Configuration ########
searchguard.ssl.transport.keystore_filepath: keystore.jks
searchguard.ssl.transport.truststore_filepath: truststore.jks
searchguard.ssl.transport.enforce_hostname_verification: false
searchguard.ssl.http.enabled: true
searchguard.ssl.http.keystore_filepath: keystore.jks
searchguard.ssl.http.truststore_filepath: truststore.jks
searchguard.authcz.admin_dn:
  - CN=kirk,OU=client,O=client,L=test, C=de

cluster.name: searchguard_demo
network.host: 0.0.0.0
######## End Search Guard Demo Configuration ########
```

Now log into https://localhost:9200/ with admin/admin, click through the certificate warning or:

`curl -k --user admin:admin https://localhost:9200`


It should show:

```
{
  "name" : "2EPefDX",
  "cluster_name" : "searchguard_demo",
  "cluster_uuid" : "sZ6iqxppQrCKpqvaHqbgZQ",
  "version" : {
    "number" : "5.2.2",
    "build_hash" : "f9d9b74",
    "build_date" : "2017-02-24T17:26:45.835Z",
    "build_snapshot" : false,
    "lucene_version" : "6.4.1"
  },
  "tagline" : "You Know, for Search"
}
```

## <a name="kibana"></a> Configure Kibana

Install the plugin.

```
bin/kibana-plugin install file:///searchguard-kibana-5.3.2-2.zip
```
Edit kibana.yml. It is not necessary to add any config optionsexcept the ElasticSearch username and password, turn off cert validation, and change http to https.  The values you leave out will default to the default values, which is fine.

```
sudo cat /usr/share/kibana/kibana-5.2.2-linux-x86_64/config/kibana.yml 

elasticsearch.username: "kibanaserver"
elasticsearch.password: "kibanaserver"
elasticsearch.url: "https://localhost:9200"
elasticsearch.ssl.verification: none
```

**Note:** **elasticsearch.ssl.verification** is spelled **elasticsearch.ssl.verificationMode** in some versions of Kibana. 


You need to give the Kibana users these rights in <ES_DIR>plugin/config/sg_internal_users.yml:

```
cat sg_internal_users.yml

sg_kibana_server:
  cluster:
      - CLUSTER_MONITOR
      - CLUSTER_COMPOSITE_OPS
  indices:
    '?kibana':
      '*':
        - ALL
```


Now login to http://localhost:5601.  You can use any of the passwords in <ES_DIR>plugin/config/sg_internal_users.yml.

## <a name="logstash"></a> Configure LogStash

`sudo vi /etc/logstash/conf.d/wordpress.conf`

```
input { file { path => "/tmp/log/*" type => "apache" start_position => "beginning" } }

output { elasticsearch 
{ hosts => ["localhost:9200"] 
user => logstash 
password => logstash 
ssl => true 
ssl_certificate_verification => false 
truststore => "/usr/share/elasticsearch/elasticsearch-5.3.2/config/truststore.jks" 
truststore_password => changeit } }


```

You need to give the Kibana users these rights in <ES_DIR>plugin/config/sg_internal_users.yml

```
cat sg_internal_users.yml


sg_logstash:
  cluster:
    - indices:admin/template/get
    - indices:admin/template/put
    - indices:data/write/bulk*
  indices:
    'logstash-*':
      '*':
        - CRUD
        - CREATE_INDEX
    '*beat*':
      '*':
        - CRUD
        - CREATE_INDEX
 Â  
```

Then start logstash.

`sudo ./logstash -f /usr/logstash/logstash-5.4.0/config/wordpress.conf`


Now you can copy some Apache logs to /tmp/log and see that show up in Elasticsearch. The traffic will now be encrypted and authenticated.
